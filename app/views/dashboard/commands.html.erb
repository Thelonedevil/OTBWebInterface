<script type="text/javascript">

    var writable;
    $(document).ready(function () {
        $.getJSON('/dashboard/is_whitelisted', function (data) {
            if (data == '1') {
                $('#tableHeadCommands').append($('<th/>').append($('<a/>').addClass('button tiny').attr('onclick', 'newCommand()').text('New')));
                writable = true;
            }
        });
        $("[name='below']").bootstrapSwitch();
        getChannelName();
        populateUserLevels();
        on_userLevelChange();

    });

    function editCommand(command) {
        alert("AHH dont edit the command: " + command);

    }
    function toggleCommand(command) {
        alert("AHH dont enable/disable the command: " + command);

    }
    function deleteCommand(command) {
        alert("AHH dont delete the command: " + command);

    }

    function newCommand() {
        // $('body').append($('<div/>',{id: 'newModal', role:'dialog'}));
        //$('#newModal').attr('data-reveal','').attr('aria-labelledby','modalTitle').attr('aria-hidden', 'true').attr('data-options', 'close_on_background_click: false;').foundation('reveal', 'open');
        $('#newModal').foundation('reveal', 'open');

    }

    function populateUserLevels() {
        var userLevelsSelect = $('#user_level');
        userLevelsSelect.append($("<option/>").val("ALL").text("All"));
        $.getJSON('/dashboard/get_user_levels', function (data) {
            $.each(data, function (index, userLevel) {
                userLevelsSelect.append($("<option/>").val(userLevel).text(userLevel.capitalize()));

            });
            $.each(data.reverse(), function (index, userLevel) {
                $('.userLevels').append($("<option/>").val(userLevel).text(userLevel.capitalize()));
            });
        });
    }
    function addNewCommand() {
        var formData = $('#ajax-new').serialize();
        $.post(window.location.href + '/add_command', formData, function (result) {
            if (result == '1') {
                on_userLevelChange();
                $('#newModal').foundation('reveal', 'close');
            } else if (result == '0') {
                $('#newModal').append($('<div/>').attr('data-alert', '').attr('role', 'alertdialog').addClass('alert-box alert').text('This Command ' + $('#command').val() + ' already exists for this channel!')/*.append($('<button/>').addClass('close').html('&times;'))*/);
            }
        });
    }

    function on_userLevelChange() {
        var userLevelsSelect = $('#user_level');
        if (userLevelsSelect.val() == 'ALL' || userLevelsSelect.val() == "DEFAULT") {
            $('#andBelow').addClass('hidden-for-small-up');
        } else {
            $('#andBelow').removeClass('hidden-for-small-up');
        }
        $.getJSON(window.location.href + '/get_commands', {
            id: userLevelsSelect.val(),
            below: !$('#below').prop("checked")
        }, function (data) {
            var table = $('#tableBodyCommands');
            table.find('tr').remove().end();
            $.each(data, function (index, command) {
                        var response = command.script == null ? command.response : "[SCRIPT] ".bold() + command.script;

                        if (command.enabled == 'true') {
                            if (writable) {
                                table.append($('<tr/>').append($('<td/>').text(command.name)).append($('<td/>').html(response)).append($('<td/>').text(command.execUserLevel.capitalize()))
                                        .append($('<td/>').append($('<button/>').addClass('button tiny dropdown').attr('href', '#').attr('data-dropdown', 'drop-' + index).text('Edit'))
                                            .append($('<ul/>').addClass('f-dropdown').attr('id', 'drop-' + index).attr('data-dropdown-content', '')
                                                .append($('<li/>').append($('<a/>').attr('onclick', "editCommand('" + command.name + "')").text('Edit')))
                                                .append($('<li/>').append($('<a/>').attr('onclick', "toggleCommand('" + command.name + "')").text('Disable')))
                                                .append($('<li/>').append($('<a/>').attr('onclick', "deleteCommand('" + command.name + "')").text('Delete')))
                                        )));
                            } else {
                                table.append($('<tr/>').append($('<td/>').text(command.name)).append($('<td/>').html(response)).append($('<td/>').text(command.execUserLevel.capitalize())));
                            }
                        } else {
                            if (writable) {
                                table.append($('<tr/>').prop('title', 'This Command is DISABLED').prop('style', 'background-color: #F9D2D4; cursor: help;')
                                        .append($('<td/>').text(command.name)).append($('<td/>').html(response)).append($('<td/>').text(command.execUserLevel.capitalize()))
                                        .append($('<td/>').append($('<button/>').addClass('button tiny dropdown').attr('href', '#').attr('data-dropdown', 'drop-' + index).text('Edit'))
                                                .append($('<ul/>').addClass('f-dropdown').attr('id', 'drop-' + index).attr('data-dropdown-content', '')
                                                        .append($('<li/>').append($('<a/>').attr('onclick', "editCommand('" + command.name + "')").text('Edit')))
                                                        .append($('<li/>').append($('<a/>').attr('onclick', "toggleCommand('" + command.name + "')").text('Enable')))
                                                        .append($('<li/>').append($('<a/>').attr('onclick', "deleteCommand('" + command.name + "')").text('Delete')))
                                        )));
                            } else {
                                table.append($('<tr/>').prop('title', 'This Command is DISABLED').prop('style', 'background-color: #F9D2D4; cursor: help;').append($('<td/>').text(command.name)).append($('<td/>').html(response)).append($('<td/>').text(command.execUserLevel.capitalize())));
                            }
                        }
                    }
            )
            ;
            $(document).foundation('dropdown', 'reflow');
        });
    }
</script>

<div id='newModal' class='reveal-modal' data-reveal aria-labelledby='modalTitle' aria-hidden='true' role="dialog" data-options="close_on_background_click: false;">
    <form id="ajax-new">
        <input name="authenticity_token" type="hidden" value="x37DrAAwyIIb7s+w2+AdoCR8cAJIpQhIetKRrPgG5VA=">
        <input name="action_type" id="action_type" type="hidden" value="new">

        <div class="field">
            <label for="command">Command:</label>
            <input type='text' id='command' name='command' required>
        </div>
        <div class="field">
            <label for="response">Response:</label>
            <input type='text' placeholder="example response" id='response' name='response'>
        </div>
        <div class="field">
            <label for="script">Script (optional; overrides 'Response'):</label>
            <input type='text' id='script' name='script'>
        </div>
        <div class="field">
            <label for="minArgs">Minimum Arguments:</label>
            <input required type='number' id='minArgs' min="0" value='0' name='minArgs'>
        </div>
        <div class="field">
            <label>Debug</label>
            <select name="debug" title="debug">
                <option>False</option>
                <option>True</option>
            </select>
        </div>
        <div class="field">
            <label>Executing UserLevel:</label>
            <select class="userLevels" name="eUL"></select>
        </div>
        <div class="field">
            <label>Name Modifying UserLevel:</label>
            <select class="userLevels" name="nMUL">
            </select>
        </div>
        <div class="field">
            <label>Response Modifying UserLevel:</label>
            <select class="userLevels" name="rMUL">
            </select>
        </div>
        <div class="field">
            <label>UserLevel Modifying UserLevel:</label>
            <select class="userLevels" name="ulMUL">
            </select>
        </div>

        <div class="field">
            <a class="button" onclick="addNewCommand()">Save</a>
        </div>
    </form>
    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
</div>
<h4 class="text-center">Commands</h4>
<form>
    <div class="row">
        <div class="large-6 columns small-centered">
            <div class="row collapse prefix-radius">
                <div class="small-3 columns small-offset-3">
                    <span class="prefix">User Level </span>
                </div>
                <div class="small-3 columns end">
                    <label for="user_level"></label>
                    <select id="user_level" onchange="on_userLevelChange()"></select>
                </div>
            </div>
        </div>
    </div>
    <div id="andBelow" class="row hidden-for-small-up" style="margin-bottom: 20px;">
        <div class="large-6 columns small-centered">
            <div class="row collapse prefix-radius">
                <div class="small-6 small-offset-3 end columns" style="text-align: center;">
                    <input onchange="on_userLevelChange()" data-label-width="auto" data-handle-width="auto" data-on-text="Yes" data-off-text="No" data-label-text="Exact" type="checkbox" name="below" id="below"/>
                    <label for="below"></label>
                </div>
            </div>
        </div>
    </div>
</form>

<table>
    <thead>
    <tr id="tableHeadCommands">
        <th style="min-width: 200px">Name</th>
        <th style="width: 100%;">Response/Script</th>
        <th style="min-width: 200px">User Level</th>
    </tr>
    </thead>
    <tbody id="tableBodyCommands">
    </tbody>
</table>

